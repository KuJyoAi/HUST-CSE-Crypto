# 链路层

## 6.1 链路层概述

### 术语

- 节点：主机和路由器
- 链路：沿着通信路径连接相邻节点的通信信道
- 帧:数据链路层的分组单元

### 服务

- 成帧,链路访问
- 差错检测
- 可靠传递
- 流量控制
- 差错纠正

## 6.2 差错检测

### CRC循环校验码

## 6.3 多路访问链路和协议

### 广播信道的特点

- 单个共享广播信道
- 两个或多个节点同时传输：相互干扰
-   碰撞：一个节点同时收到两个或多个信号

### 信道划分协议

- 将信道划分成小的“片”（时隙、频率、编码）
- 将“片”分配给节点使用
- 种类

	- TDMA
	- FDMA
	- CDMA

### 随机访问协议

- 信道没有被分割，允许碰撞
- 碰撞恢复
- ALOHA

	- 纯ALOHA
	- 时隙ALOHA

- 碰撞

	- 当一个结点传输数据的时候收到了别的结点发来的数据就叫做碰撞.
	- 强化碰撞:当发送数据的站一旦发现发生了碰撞时，除了立即停止发送数据外，还要再继续发送若干比特的人为干扰信号
	- 最先发送数据帧的站，在发送数据帧后至多经过时间 2t （两倍的端到端时延）就可知道发送的数据帧是否遭受了碰撞。以太网的端到端往返时延 2t称为争用期，或碰撞窗口。

### 轮流协议

- 节点轮流传送，但数据量大的节点轮流更长时间
- 主节点邀请从节点轮流传输
- 控制令牌依次通过各个结点

## 6.4 交换局域网

### Mac地址

- 在数据链路层标识每块网络适配器，使得能够在广播信道上寻址目标节点,48位

### 地址解析协议（ARP）

- 根据目标的IP地址获取其MAC地址
- ARP缓存:局域网节点的IP/MAC地址映射
- ARP请求包

	- 目的为FF-FF-FF-FF-FF,包含自己源的Mac头
	- IP报头
	- ARP报文:你的Mac是啥啊

- ARP应答报

	- 源是自己Mac地址的报头
	- IP报头
	- ARP报文:我的Mac是...

- 注意:每一次经过路由器都更新一遍Mac头,但是不会更新IP头,Mac头的目的会是下一个路由器Mac,源就是自己路由器的Mac

### 以太网

- 帧

	- 结构

		- 数据
		- 首部

			- 同步码
			- 源Mac
			- 目的Mac
			- 类型

		- 尾部CRC

- CSMA/CD

	- 特点

		- 没有时隙
		- 当适配器侦听到其它适配器在传输，则它不传输帧, 即载波侦听
		- 正在传输的适配器若检测到其它适配器也在传输，则它中止自己的传输, 即碰撞检测
		- 在重新传输之前，适配器要等待一段随机时间，即随机回退

	- 几个定义

		- 拥塞信号: 用来确保所有传输者都能检测到碰撞而传输的信号；48比特长
		- 比特时间: 传输1比特所需时间。在10Mbps的以太网中，当K=1023时，等待时间大约为50ms

	- 指数回退

		- 中止传输后，适配器进入指数回退阶段，在经历第m次碰撞后，适配器随机从{0,1,2,…,2m-1}中选择K值。适配器在等待 K·512比特时间后在重传

	- 争用期

		- 以太网取 51.2us 为争用期的长度。
		- 对于 10 Mb/s 以太网，在争用期内可发送512 bit，即 64 字节。

	- 最短有效帧长

		- 以太网规定了最短有效帧长为 64 字节，凡长度小于 64 字节的帧都是由于冲突而异常中止的无效帧。

	- 信号编码

		- 曼彻斯特编码
		- 差分曼彻斯特编码

- 链路层交换机

	- 工作原理

		- 不断监听各接口是否有信号
		- 收到无差错的帧则缓存，反之将差错帧丢弃
		- 若所收帧的目的MAC地址属另一网段，则通过站表决定向何接口转发
		- 交换机不转发同一网段内通信的帧
		- 交换机不修改所转发的帧的源地址

	- 交换机是透明的

		- 这里所谓“透明”是指局域网上的每个站并不知道所发送的帧将经过哪几个交换机，即交换机对各站来说是看不见的

	- 选路原理

		- ① 从接口x收到帧，有差错则丢弃，否则在站表中查找目的站MAC地址；
		- ② 找到有，则取出相应的接口d，转③，否则转⑤；
		- ③ 如果所给MAC地址的接口d=x，则丢弃此帧（不需要转发），否则从接口d转发此帧；
		- ④ 转到⑥；
		- ⑤ 向除x以外的所有接口转发此帧（可保证找到目的站）
		- ⑥ 如源站不在站表中，则将源站MAC地址写入站表，登记该帧进入交换机的接口号和时间，设置计时器，然后转⑧。否则转⑦；
		- ⑦ 更新计时器（由于网络拓扑经常变化，因此，超时记录要删除，以反映最新状态）；
		- ⑧ 等待新的数据帧。转①
		- 支撑树---交换机互相知道各自的拓扑结构,构建一个最小生成树.

### VLAN

- 局域网交换机是组建虚拟局域网的核心设备。
- 组成逻辑工作组的各结点不受物理位置的限制，换言之同一逻辑工作组的成员不一定要连接在同一个物理网段上。
- 当一个结点从一个逻辑工作组转移到另一个逻辑工作组时，只需要通过软件设定，而不需要改变它在网络中的物理位置。
- 不同的子网就是不同的VLAN,所以说VLAN具有流量隔离的作用,一个VLAN的内容只能传输到同一个VLAN或者trunk端口里面.
- 从一个VLAN转发到不同的VLAN里面,先转发到trunk端口,通过trunk端口进入路由器完成转发.

## 集线器--单纯把几个机器连接在一起,碰撞域变大,集线器左边的元素会影响集线器右边的元素传递数据,但是集线器左边和右边就互联了

*XMind - Trial Version*